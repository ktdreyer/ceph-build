- job:
    name: ceph
    description: 'This is the main ceph build task which uses chacra.ceph.com.'
    project-type: multijob
    defaults: global
    display-name: 'ceph'
    logrotate:
      daysToKeep: -1
      numToKeep: 25
      artifactDaysToKeep: 25
      artifactNumToKeep: 25
    block-downstream: false
    block-upstream: false
    properties:
      - github:
          url: https://github.com/ceph/ceph

    parameters:
      - string:
          name: BRANCH
          description: "The git branch (or tag) to build"
          default: master

      - bool:
          name: TEST
          description: "
If this is unchecked, then the builds will be pushed to chacra with the correct ref. This is the default.

If this is checked, then the builds will be pushed to chacra under the 'test' ref."
      - bool:
          name: TAG
          description: "When this is checked, Jenkins will remove the previous private tag and recreate it again, changing the control files and committing again. When this is unchecked, Jenkins will not do any commit or tag operations. If you've already created the private tag separately, then leave this unchecked."
          default: true

      - bool:
          name: FORCE
          description: "
If this is unchecked, then then nothing is built or pushed if they already exist in chacra. This is the default.

If this is checked, then the binaries will be built and pushed to chacra even if they already exist in chacra."
      - string:
          name: VERSION
          description: "The version for release, e.g. 0.94.4"

    builders:
      # Create a new tag and build from the private repo only if the user
      # specified a $VERSION.
      - conditional-step:
          condition-kind: shell
          condition-command: 'if [ "$VERSION" = "" ]; then exit 1; fi'
          steps:
            - multijob:
                name: 'ceph tag and setup phase (from private repo)'
                condition: SUCCESSFUL
                projects:
                  - name: ceph-tag
                    current-parameters: true
                    exposed-scm: false
                  - name: ceph-setup-next
                    current-parameters: true
                    exposed-scm: false
                    predefined-parameters: REPO=git@github.com:ceph/ceph-releases.git
      # If the user left $VERSION unspecified, then assume we should build
      # directly from the public repository, without tagging.
      - conditional-step:
          condition-kind: shell
          condition-command: 'if [ "$VERSION" = "" ]; then exit 0; else exit 1; fi'
          steps:
            - multijob:
                name: 'ceph setup phase (from public repo)'
                condition: SUCCESSFUL
                projects:
                  - name: ceph-setup-next
                    current-parameters: true
                    exposed-scm: false
                    predefined-parameters: REPO=https://github.com/ceph/ceph
      - multijob:
          name: 'ceph build phase'
          condition: SUCCESSFUL
          projects:
            - name: ceph-build
              current-parameters: true
              exposed-scm: false

    wrappers:
      - inject-passwords:
          global: true
          mask-password-params: true
